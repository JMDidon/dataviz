// Generated by CoffeeScript 1.6.1
(function(){$(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F;$.ajaxSetup({async:!1});N=$("#sidebar-wrapper");v=$("#sidebar-filter");_=$("#sidebar-toggler");w=$("#map");A=$("#timeline");c=$("#cursor_start");l=$("#cursor_end");p=$("#episodes");e=r=i=t=s=E=[];n=0;o=1;m=function(e,t,n){return e.filter(function(e,r){return e[t]===n})};O=function(e,t){return setTimeout(t,e)};C=function(e){return e.toLowerCase().replace(new RegExp(" ","g"),"-").replace(/[^\w-]+/g,"")};u=function(e){return e=e.toString().length===1?"0"+e:e};b=function(e){return'<li><input type="checkbox" id="house_'+e.i+'" class="sidebar-check-house"><label for="house_'+e.i+'" class="sidebar-item-house"><img src="//drive.google.com/uc?export=download&confirm=no_antivirus&id='+e.img+'"> '+e.name+"</label><ul></ul></li>"};f=function(e){return'<li><input type="checkbox" id="char_'+e.i+"_"+e.j+'" class="sidebar-check-char" data-name="'+e.name+'"><label for="char_'+e.i+"_"+e.j+'" class="sidebar-item-char"><label><img src="//drive.google.com/uc?export=download&confirm=no_antivirus&id='+e.img+'" width="40" height="40" class="photo" style="border-color:'+e.color+'"> '+e.name+"</label></li>"};a=function(e){return'<figure><a href="'+e.url+'" target="_blank"><img src="//drive.google.com/uc?export=download&confirm=no_antivirus&id='+e.img+'" width="40" height="40" class="photo '+e.dead+'" style="border-color:'+e.color+'" title="'+e.name+'"><figcaption>'+e.episode+"</figcaption></a></figure>"};d=function(e){return e.first.id+': <a href="'+e.first.url+'" target="_blank">'+e.first.name+"</a> ~ "+e.last.id+': <a href="'+e.last.url+'" target="_blank">'+e.last.name+"</a>"};v.val(v[0].dataset.placeholder);v.on("focus",function(){if(this.value===this.dataset.placeholder)return $(this).val("")});v.on("blur",function(){if($.trim($(this).val())==="")return $(this).val(this.dataset.placeholder)});k=function(){var t,n,i,s,o,u,a;i=function(e,t){return e.name>t.name};r.sort(i);for(s=0,u=r.length;s<u;s++){n=r[s];n.characters=[];for(o=0,a=e.length;o<a;o++){t=e[o];t.house===n.name&&n.characters.push(t)}n.characters.sort(i)}return r=r.filter(function(e,t){return e.characters.length})};F=function(){var e,t,n,i,s,o,u,a,l,c,h;h=[];for(i=o=0,a=r.length;o<a;i=++o){t=r[i];n=$(b({i:i,name:t.name,img:t.image}));c=t.characters;for(s=u=0,l=c.length;u<l;s=++u){e=c[s];$(f({i:i,j:s,name:e.name,img:e.image,color:t.color})).appendTo(n.children("ul"))}h.push(n.appendTo(N))}return h};y=function(){var e,t,n,r,s,o;for(n in E){s=E[n];if(typeof s!="object")continue;r=m(i,"name",s.name);if(!r.length)continue;delete r[0].name;delete r[0].find;s.moves=function(){var n,i;n=r[0];i=[];for(e in n){t=n[e];i.push(t)}return i}()}o=[];for(n in E){s=E[n];o.push(s)}return o};S=function(){var e;$(".sidebar-check-house").on("change",function(){var e;e=$(this).is(":checked");return $(this).parents("li").find("input").not(this).each(function(){this.checked=e;return $(this).change()})});e=!1;return $(".sidebar-check-char").on("change",function(){var t,n,i,s;s=$(this).parents("li");n=s.find(".sidebar-check-house");t=s.find(".sidebar-check-char");$(this).is(":not(:checked)")&&n.attr("checked",!1);n.is(":not(:checked)")&&t.filter(":checked").length===t.length&&n.click();i=$(this).attr("id").match(/char_([0-9]+)_([0-9]+)/);$(this).is(":checked")?E[$(this).attr("id")]=r[parseInt(i[1])].characters[parseInt(i[2])]:delete E[$(this).attr("id")];clearTimeout(e);return e=O(50,function(){return B(y())})})};T=function(){return v.on("keyup",function(){var e;e=this.value.toLowerCase();return $(".sidebar-check-char").each(function(){var t;t=$(this).parent();return this.dataset.name.toLowerCase().indexOf(e)>-1?t.slideDown():t.slideUp()})})};M=function(){var e;e=$(".sidebar-check-house:checked").length!==$(".sidebar-check-house").length;return $(".sidebar-check-house").each(function(){this.checked=e;return $(this).change()})};B=function(e){w.empty();return $.each(e,function(e,t){var i,u,f;u=t.moves.filter(function(e,t){return t>=n&&t<=o&&$.trim(e)!==""});i=m(r,"name",t.house)[0].color;t.dead="";f=[];$.each(u,function(e,n){var r,o;if(/Dead:.+/.test(n)){n=n.replace("Dead:","");t.dead="dead"}r=m(s,"name",n)[0];if(r){o=$('<div id="'+C(n)+'" class="map-pt"><div class="map-pt-box"><h2 class="map-pt-name">');o.find(".map-pt-name").text(r.name);o.css({left:r.x+"%",top:r.y+"%"});$(w).find("#"+C(n)).length||o.appendTo(w);f.push([parseFloat(r.x)*9,parseFloat(r.y)*6.5]);if(e===u.length-1)return $(a({episode:g(e),name:t.name,url:t.url,dead:t.dead,img:t.image,color:i})).appendTo(w.find("#"+C(n)).children(".map-pt-box"))}});return h(f,i)})};x=function(){l.css("left",l.offset().left-A.offset().left+L);return $(".cursor").draggable({grid:[L,0],axis:"x",snap:!0,snapMode:"both",containment:A,cursor:"pointer",opacity:"0.5",drag:function(){j();return H()},stop:function(){var e;if(parseInt(c.offset().left)>=parseInt(l.offset().left)-L){e=$(this).is(l)?1:-1;$(this).css("left",$(".cursor").not(this).offset().left-A.offset().left+e*L)}j();H();return B(y())}})};j=function(){n=Math.ceil((c.offset().left-A.offset().left)/L);return o=Math.ceil((l.offset().left-A.offset().left)/L)};H=function(){c.text(g(n));l.text(g(o));return p.html(d({first:t[n],last:t[o]}))};g=function(e){return"S0"+Math.ceil((e+1)/10)+"E"+u(e%10+1)};D=function(e){return e.transition().duration(2e3).attrTween("stroke-dasharray",P)};P=function(){var e,t;t=this.getTotalLength();e=d3.interpolateString("0,"+t,t+","+t);return function(t){return e(t)}};h=function(e,t){var n,r;t==null&&(t="#000");n=d3.svg.line();r=d3.select(".map").append("svg").datum(e);r.append("path").style("stroke",t).style("opacity",".5").style("stroke-dasharray","1,3").attr("d",n);return r.append("path").style("stroke",t).attr("d",n).call(D)};$.get("api/get/characters",function(t){return e=JSON.parse(t)});$.get("api/get/houses",function(e){return r=JSON.parse(e)});$.get("api/get/moves",function(e){return i=JSON.parse(e)});$.get("api/get/episodes",function(e){return t=JSON.parse(e)});$.get("api/get/places",function(e){return s=JSON.parse(e)});L=(A.width()-c.width())/(t.length-1);k();F();S();T();_.on("click",M);M();x();return H()})}).call(this);